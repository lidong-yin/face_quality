## 1. SDD: Face Image Quality Assessment (FIQA)

![sdd-fiqa](sdd-fiqa.png 'sdd-fiqa')

作者引用了EVRC(误差拒绝曲线)的原理，受其启发，提出通过FNMR(错误匹配率)的下降程度来定义图像质量的伪标签。

论文前面的公式1，2，3，4，5，6等公式只是引入概念，和后面实际用到的公式没啥强联系。

前面的公式1，2，3，4，5只是为了推导出来 $Q{x_i}=\mathbf{F}(S_{x_i}^P, S_{x_i}^N)$，也就是质量为标签的分值与集合 $S_{xi}^P,S_{xi}^N$有关，具体关系就是 $F(*)$，论文在公式 (6) 之后立即给出了一段直观的解释：“高质量人脸图像总是容易被识别。这意味着它与同类样本接近，与异类样本远离。换句话说，Pos-Sim 和 Neg-Sim 之间的距离很大。”仅此而已，没有别的作用了，这个分值很显然与正负样本集合有关。后面作者选用了韦氏距离来作为$F(*)$具体形式。

主要用韦氏距离来衡量两个分布之间的距离大小，作为质量评分。

## 2. CR-FIQA: Face Image Quality Assessment by Learning...
![cr-fiqa](cr-fiqa.png 'cr-fiqa')
这篇论文也不难理解，从上一篇的SDD实验也能推出来这种想法。仔细观察SDD的方法，负样本其实是不起作用的，对于一个10万或100万的数据集来讲，负样本对基本退化为一致的分布，所以此时计算距离的唯一变量是正样本对之间的距离。

CR-FIQA的度量方法主要和簇的中心有关。
- **核心概念：相对可分类性 (Relative Classifiability)** 论文提出，一张高质量的人脸图像应该能被分类模型轻易地正确分类。也就是说，在特征空间中，它应该离它自己身份的类别中心很近，同时离其他身份的类别中心很远。
- **关键指标：确定性比率 (Certainty Ratio, CR)** 为了量化“相对可分类性”，作者定义了一个名为“确定性比率”的指标。它的计算方式如下：
    - **分子 (CCS)**：样本特征与其类别中心的**角度余弦相似度** (Class Center Angular Similarity)。这个值越大，代表样本离自己的类别中心越近。
    - **分母 (NNCCS)**：样本特征与**最近的负类（其他身份）中心**的**角度余弦相似度** (Closest Nearest Negative Class Center Angular Similarity)。
因此，一个高质量的样本，其CR值会更高，因为它应该有更大的CCS值和更小的NNCCS值。

**类别中心如何定义的？**
在训练人脸模型时，最后一层的输出是一个分类层，使用ArcFace相关的间距对应的类别为$c_i, c_i\in C$，一共有$C$ 类。其最后一层的权重矩阵为$W\in \mathbb{R}^{C\times d}$，所以不难推导，该权重的第$j$列$w_j$应为簇$c_j$的中心。


## 3. 问题分析

### 3.1 SDD两类缺陷
1. 混淆“一致性”与“高质量”，它无法区分 “簇内样本的高度一致性” 和 “簇内样本的高质量”（次要问题、少数）
  - 当我们从一个簇中选择正样本时，假如该簇基本都是同一张相近的图片，他的整体得分就很高... 当一个簇中的所有图片质量都很差，但基本都是一个人，此时的相似度得分也会很高... 而负样本... 分布基本是一致的。最后就会导致质量好和质量差的图片的得分都是偏高的。
    - 场景A：高质量且高度一致的簇
             数据：一个人的10张证件照，光照、姿态、表情都非常标准且相似。
             Pos-Sim 分布：由于图片质量高且相似，任意两张图片之间的特征余弦相似度都会非常高，比如稳定在[0.85, 0.95] 这个区间。这是一个非常靠右（高分）且集中的分布。
             Neg-Sim 分布：从全局随机采样，分布稳定在 [-0.2, 0.4]。
             韦氏距离：一个靠右的窄分布和一个靠左的分布之间的距离非常大。
             结论：算法给出了高分，这是正确的。
    - 场景B：低质量但高度一致的簇
             数据：一个摄像头在同一位置、同一光线下，连续抓拍了10张一个人的严重模糊、低分辨率的人脸图片。
             Pos-Sim 分布：尽管每张图片质量都极差，但由于它们的退化模式（模糊、低分辨率）是完全一致的，识别模型从它们身上提取出的“垃圾特征”也是高度相似的！因此，它们之间的余弦相似度同样会非常高，比如也稳定在 [0.80, 0.90] 这个区间。这个分布同样是靠右且集中的。
             Neg-Sim 分布：同样，从全局随机采样，分布稳定在 [-0.2, 0.4]。
             韦氏距离：同样非常大。
             结论：算法给出了高分，错误地将“低质量但长得都一样”的图片判定为了高质量。

2. 分值偏移，本质上正样本簇的分布不具有代表性（主要问题、多数）
  - 某个簇中有一个质量好的，剩下的都是质量差的，其质量差的之间的相似度比较高，质量好的相似度反而没那么高，此时... 质量差的图片得到的分值会比质量好的分值要高。

### 3.2 CR-FIQA缺陷
根据CR-FIQA的方法原理，同样存在分值偏移缺陷；负样本使用非同类中最相近的簇中心来评估，距离相比SDD拉的更开，这是比SDD好的一点。

### 3.3 如何做高质量伪标签

还是要回归到如何做高质量数据，从一个高质量的种子数据出发，不断迭代，形成数据飞轮。

种子的数据应该是一个标准的，符合训练目标的的数据。从这个角度分析，种子数据的质量是关键，如果种子数据质量不好，那么后续的迭代数据质量也不会好。

具体的，可以对簇数据进行分层采样，保证每个簇的均匀性和多样性，每个簇中包含高中低质量的数据。

使用不同层级的阈值进行聚类，形成不同层级的簇，然后对每个簇进行分层采样，保证每个簇的均匀性和多样性。

如果本身数据就有相关的属性，也可从属性中进行分层级的筛选，得到多样化的数据。